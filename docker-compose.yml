version: '3.8'

services:
  snyk:
    image: snyk/snyk:linux
    container_name: shareconnect-snyk
    working_dir: /app
    volumes:
      - .:/app
      - /tmp:/tmp
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - SNYK_TOKEN=${SNYK_TOKEN}
      - SNYK_INTEGRATION_NAME=ShareConnect
      - SNYK_INTEGRATION_VERSION=1.0.0
      - SNYK_CFG_ORG=${SNYK_ORG_ID}
      - SNYK_DISABLE_ANALYTICS=1
      - DOCKER_HOST=unix:///var/run/docker.sock
    networks:
      - snyk-network
    extra_hosts:
      - host.docker.internal:host-gateway
    command: >
      sh -c "
        echo 'ðŸ” ShareConnect Snyk Security Scanning' &&
        echo '======================================' &&
        echo '' &&
        echo 'ðŸ”§ Testing configuration...' &&
        snyk config &&
        echo '' &&
        echo 'ðŸ“¦ Scanning dependencies...' &&
        snyk test --all-projects --detection-depth=6 --severity-threshold=medium --json > /tmp/snyk-deps-results.json || true &&
        echo '' &&
        echo 'ðŸ³ Scanning container images...' &&
        snyk container test --file=Dockerfile --json > /tmp/snyk-container-results.json 2>/dev/null || echo 'No container images to scan' &&
        echo '' &&
        echo 'ðŸ“± Scanning Android dependencies...' &&
        find . -name 'build.gradle*' -exec snyk test --file={} --json > /tmp/snyk-gradle-results.json \; 2>/dev/null || true &&
        echo '' &&
        echo 'ðŸ“Š Generating reports...' &&
        snyk-to-html -i /tmp/snyk-deps-results.json -o /tmp/snyk-report.html 2>/dev/null || echo 'HTML report generation failed' &&
        # Create comprehensive summary report
        echo 'ðŸ“ Generating scan summary...' &&
        {
            echo "# Snyk Security Scan Summary"
            echo "Generated: $(date)"
            echo ""
            echo "## Dependency Scan"
            jq -r '.vulnerabilities[] | "- \(.severity | ascii_upcase) severity: \(.title) in \(.moduleName)"' /tmp/snyk-deps-results.json || echo "No vulnerabilities found"
            echo ""
            echo "## Container Scan"
            jq -r '.vulnerabilities[] | "- \(.severity | ascii_upcase) severity: \(.title) in \(.image)"' /tmp/snyk-container-results.json 2>/dev/null || echo "No vulnerabilities found"
        } > /tmp/snyk-summary.md &&
        echo 'âœ… Snyk scanning completed'
      "

  snyk-cli:
    image: snyk/snyk-cli:latest
    container_name: shareconnect-snyk-cli
    working_dir: /workspace
    volumes:
      - .:/workspace
      - snyk_cache:/root/.snyk
    environment:
      - SNYK_TOKEN=${SNYK_TOKEN}
      - SNYK_INTEGRATION_NAME=ShareConnect
      - SNYK_INTEGRATION_VERSION=1.0.0
      - SNYK_CFG_ORG=${SNYK_ORG_ID}
      - SNYK_DISABLE_ANALYTICS=1
      - SNYK_ADDITIONAL_ARGS=--all-projects --detection-depth=6 --severity-threshold=medium
    networks:
      - snyk-network
    profiles:
      - cli

volumes:
  snyk_cache:
    driver: local

networks:
  snyk-network:
    driver: bridge